```{r}
library(devtools)
library(pmartRdata)
document("~/Git_Repos/pmartR/")
load_all("~/Git_Repos/pmartR")
```

## Abundance Boxplots

#### Expression Matrix Only

Cognostics must be: N, Mean, Median, CV 

```{r}
trelliData1 <- as.trelliData.edata(e_data = lipid_pos_edata,
                                  edata_cname = "Lipid",
                                  omics_type = "lipidData")

# Should return sample count, and mean, median, and cv abundance
trelli_panel_by(trelliData = trelliData1, panel = "Lipid") %>% 
   trelli_abundance_boxplot(test_mode = TRUE, 
                            test_example = 1:10, 
                            cognostics = c("count", "mean abundance", "median abundance", "cv abundance"))

# Should return sample count, mean abundance, and median abundance
trelli_panel_by(trelliData = trelliData1, panel = "Lipid") %>% 
   trelli_abundance_boxplot(test_mode = TRUE, 
                            test_example = 1:10, 
                            cognostics = c("count", "mean abundance", "median abundance"))

# Should return sample count and mean abundance
trelli_panel_by(trelliData = trelliData1, panel = "Lipid") %>% 
   trelli_abundance_boxplot(test_mode = TRUE, 
                            test_example = 1:10)

# Should return sample count, and mean, median, and cv abundance
trelli_panel_by(trelliData = trelliData1, panel = "Lipid") %>% 
   trelli_abundance_boxplot(test_mode = TRUE, 
                            test_example = 1:10, 
                            cognostics = c("count", "mean abundance", "median abundance", "cv abundance", "anova p-value"))

# Should return biomolecule count, and mean, median, and cv abundance
trelli_panel_by(trelliData = trelliData1, panel = "Sample") %>% 
   trelli_abundance_boxplot(test_mode = TRUE, 
                            test_example = 1:10, 
                            cognostics = c("count", "mean abundance", "median abundance", "cv abundance", "anova p-value"))
```

#### Grouping Information Included

```{r}
lipid_emeta <- data.frame("Lipid" = lipid_pos_edata$Lipid, 
  "LipidFamily" = lipid_pos_edata$Lipid %>% as.character() %>% 
    strsplit("(", fixed = TRUE) %>% lapply(function(el) {el[1]}) %>% unlist())

# Transform the data
omicsData <- edata_transform(omicsData = lipid_pos_object, data_scale = "log2")
omicsData$e_meta$LipidFamily <- omicsData$e_meta$Lipid %>% as.character() %>% 
    strsplit("(", fixed = TRUE) %>% lapply(function(el) {el[1]}) %>% unlist()

# Group the data by condition
omicsData <- group_designation(omicsData = omicsData, main_effects = c("Virus"))

# Apply the IMD ANOVA filter
imdanova_Filt <- imdanova_filter(omicsData = omicsData)
omicsData <- applyFilt(filter_object = imdanova_Filt, omicsData = omicsData, min_nonmiss_anova=2)

# Normalize my pepData
omicsData <- normalize_global(omicsData, "subset_fn" = "all", "norm_fn" = "median", "apply_norm" = TRUE, "backtransform" = TRUE)

# Implement the IMD ANOVA method and compute all pairwise comparisons (i.e. leave the `comparisons` argument NULL)
statRes <- imd_anova(omicsData = omicsData, test_method = 'combined')

# Generate the trelliData object 
trelliData2 <- as.trelliData(omicsData = omicsData)
trelliData3 <- as.trelliData(statRes = statRes)   
trelliData4 <- as.trelliData(omicsData = omicsData, statRes = statRes)
```

```{r}
# Should return sample count and mean abundance per group
trelli_panel_by(trelliData = trelliData2, panel = "Lipid") %>% 
   trelli_abundance_boxplot(test_mode = TRUE, 
                            test_example = 1:10)

# Should return mean abundance per group
trelli_panel_by(trelliData = trelliData2, panel = "Lipid") %>%
  trelli_abundance_boxplot(test_mode = TRUE, test_example = 1:10, cognostics = c("mean abundance", "median abundance", "anova p-value"))

# Should return no cognostics 
trelli_panel_by(trelliData = trelliData2, panel = "Lipid") %>%
  trelli_abundance_boxplot(test_mode = TRUE, test_example = 1:10, cognostics = c("median abundance", "anova p-value"))

# Should return biomolecule count and mean abundance 
trelli_panel_by(trelliData = trelliData2, panel = "SampleID") %>%
  trelli_abundance_boxplot(test_mode = TRUE, test_example = 1:10)

# Should return biomolecule count and mean abundance per biomolecule class
trelli_panel_by(trelliData = trelliData2, panel = "LipidFamily") %>%
     trelli_abundance_boxplot()
```

#### Statistics Included 

```{r}
# Stats only should error out 
#trelli_panel_by(trelliData = trelliData3, panel = "Lipid") %>% 
#  trelli_abundance_boxplot()

# Should return sample count and mean abundance per group
trelli_panel_by(trelliData = trelliData4, panel = "Lipid") %>% 
  trelli_abundance_boxplot(test_mode = TRUE, test_example = 1:10)

# Should return sample count and mean abundance per group, and anova p value and fold change
# per comparison
trelli_panel_by(trelliData = trelliData4, panel = "Lipid") %>% 
  trelli_abundance_boxplot(test_mode = TRUE, test_example = 1:10,
                           cognostics = c("count", "mean abundance", "median abundance", "cv abundance", "anova p-value", "fold change"))

```



